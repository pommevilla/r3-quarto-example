{
  "hash": "4a12912b31ed4192dad4c6aa2e4c6098",
  "result": {
    "markdown": "---\ntitle: \"Sample Analysis\"\n---\n\n::: {.cell}\n\n:::\n\nThis is some preliminary analysis I did for an experiment we're doing to quantify the effects of crop priming on nitrogen fixation rates.\nYou can see the latest version of this analysis [at my research journal](https://pommevilla.github.io/crop_priming/analysis_so_far.html) and learn more about the experiment at [my website](https://pommevilla.netlify.app/project/20210823_icrop_priming/).\nAlso note that you can view the source code of this page by click on the `Code` button to the right of the title of this page.\n\n\n### Data\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Reading in the data\"}\ndata.priming <- read.csv(\"data/priming_amoA_deltaCt.csv\", header = T) %>% \n  rename(sample_id = X) \n\ndata.raw <- read.csv(\"data/priming_amoA_rawCt.csv\", header = T) %>% \n  rename(sample_id = X)\n\ndata.priming.long <- data.priming %>% \n  pivot_longer(cols = starts_with(\"amoA\"), names_to = \"amoA\", values_to = \"deltaCT\")\n\ndata.raw.long <- data.raw %>% \n  pivot_longer(cols = starts_with(\"amoA\"), names_to = \"amoA\", values_to = \"CT\")\n\ndata.priming.long$sample_id <- fct_reorder(data.priming.long$sample_id, parse_number(data.priming.long$sample_id))\n\ndf <- data.priming[, -1]\nrownames(df) <- data.priming[, 1]\n\nmetadata <- df %>% \n  select(fert_level:field_rep) %>%\n  mutate(across(everything(), as.factor))\n\n\namoa_counts <- df %>% \n  select(starts_with(\"amoA\"))\n```\n:::\n\n`data.priming` contains the data for our experiment. There are rows for samples, columns for the \ndelta CTs of the different amoAs, and some metadata.\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.priming[1:5, 1:5]\n```\n\n::: {.cell-output-stdout}\n```\n  sample_id  amoA.001 amoA.002  amoA.003  amoA.004\n1        2b 10.119249 27.41268  8.764504  8.992937\n2       35b  9.837943 27.51089  9.300077 10.445448\n3       52f 26.345485 26.34548 26.345485 26.345485\n4       34f 26.914432 26.91443 26.914432 26.914432\n5       16f  8.337293 25.94591  8.371314 25.945907\n```\n:::\n:::\n\n`data.raw` contains the same columns but lists the raw CT values instead of the 16s-normalized ones.\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.raw[1:5, 1:5]\n```\n\n::: {.cell-output-stdout}\n```\n  sample_id amoA.001 amoA.002 amoA.003 amoA.004\n1        2b 22.70657       40 21.35182 21.58026\n2       35b 22.32706       40 21.78919 22.93456\n3       52f 40.00000       40 40.00000 40.00000\n4       34f 40.00000       40 40.00000 40.00000\n5       16f 22.39139       40 22.42541 40.00000\n```\n:::\n:::\n\nTHe `long` versions of these dataframes contains the same info but in long format to play nicely\nwith `ggplot`.\n\n## Removing amoAs\n\nWe'll start by removing those amoAs from our data that are not present in over 30 samples across both treatments.\n\nWe'll first start by counting the non-detects for each amoA.\n\n::: {.cell}\n\n```{.r .cell-code}\nnon_detect_counts <- data.raw.long %>%\n  group_by(fert_level, amoA) %>% \n  count(CT == 40) %>% \n  rename(non_detect = `CT == 40`) %>%\n  filter(non_detect == TRUE)\n```\n:::\n\nFinding the amoAs that are not detected in > 30 across both samples\n\n::: {.cell}\n\n```{.r .cell-code}\nremoves <- non_detect_counts %>% \n  pivot_wider(names_from = fert_level, values_from = n, names_prefix = \"fert.\") %>%\n  filter(fert.0 > 30 & fert.336 > 30) %>%\n  pivot_longer(cols = fert.0:fert.336, names_to = \"fert_level\", values_to = \"n\")\n```\n:::\n\nWe'll now reduce `data.priming` by removing those amoAs that are largely non-detects. \nWe'll also update the `long` version while we're at it\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.priming.reduced <- data.priming %>% \n   select(-one_of(removes$amoA))\n\ndata.priming.reduced.long <- data.priming.reduced %>% \n  select(-sample_id, field_rep) %>% \n  pivot_longer(cols = contains(\"amoa\")) \n```\n:::\n\nHere's a barchart of what we're removing:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nremoves %>% \n  mutate(amoA = str_sub(amoA, -3)) %>% \n  mutate(favored = case_when(\n    amoA %in% c(\"006\", \"038\", \"064\", \"069\", \"071\") ~ \"Nothing\",\n    amoA %in% c(\"021\", \"028\", \"030\", \"048\", \"073\", \"075\", \"076\", \"077\", \"078\") ~ \"Non-fertilized\",\n    amoA %in% c(\"040\", \"050\", \"053\") ~ \"Fourth quadrant\",\n    TRUE ~ \"First quadrant\"\n  )) %>% \n  mutate(fert_level = str_sub(fert_level, start = 6)) %>% \n  ggplot(aes(amoA, n, fill = favored )) +\n  geom_col() +\n  facet_wrap(~ fert_level) + \n  theme(\n    plot.title = element_text(hjust = 0.5),\n    legend.text = element_markdown(size = 12),\n    legend.title = element_markdown(size = 12, hjust = 0),\n    strip.background = element_rect(size = 1, color = \"black\", fill = \"NA\"),\n    panel.grid = element_line(color = \"gray95\"),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.border = element_rect(color = \"black\", size = 1, fill = NA)\n  ) +\n  scale_fill_viridis_d(begin = 0, end = 0.5) +\n  scale_y_continuous(limits = c(0, 50), expand = expansion(add = c(0, 0))) +\n  scale_x_discrete(limits = rev) + \n  coord_flip() + \n  labs(\n    y = \"Number of samples with > 30 non-detects\",\n    title = \"Fertilizer level\",\n    fill = \"Favored by...\"\n  )\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-16-1.pdf)\n:::\n:::\n\nNote that most of the non-detects that we're removing are from the non-fertilized group.\n\nNext, we'll convert the CT values to presence/absence for use in later analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\namoA_presence_absence <- data.raw %>% \n  select(sample_id, starts_with(\"amoA\")) %>%\n  mutate(across(starts_with(\"amoA\"), ~ ifelse(.x == 40, 0, 1))) \n```\n:::\n\n## Ordination\n\nCalculating the NMDS (positioning the sites):\n\n::: {.cell}\n\n```{.r .cell-code}\nmds.priming = metaMDS(data.priming.reduced %>% select(contains(\"amoa\")), distance = \"bray\", k = 3)\n\nsite.scores <- as.data.frame(scores(mds.priming, display = \"sites\")) %>% \n  mutate(sample_id = data.priming.reduced$sample_id,\n         Crop = data.priming.reduced$crop,\n         Fert_Level = as.factor(data.priming.reduced$fert_level),\n         Day = as.factor(data.priming.reduced$doe),\n         Substrate_Addition = as.factor(data.priming.reduced$addition))\n```\n:::\n\nThis is enough to plot a basic NMDS:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Plotting the NMDS\"}\nnmds.plot <- site.scores %>% \n  ggplot(aes(NMDS1, NMDS2, fill = Fert_Level)) +  \n  geom_hline(yintercept = 0.0,\n             colour = \"grey\",\n             lty = 2) +\n  geom_vline(xintercept = 0.0,\n             colour = \"grey\",\n             lty = 2) +\n  geom_point(size = 4, shape = 21) + \n    theme(\n    plot.title = element_text(hjust = 0.5),\n    legend.text = element_markdown(size = 12),\n    legend.title = element_markdown(size = 12, hjust = 0),\n    axis.text.x = element_text(size = 14),\n    axis.text.y = element_text(size = 14),\n    axis.title.x = element_text(size = 12),\n    axis.title.y = element_text(size = 12),\n    panel.grid = element_line(color = \"gray95\"),\n    panel.border = element_rect(color = \"black\", size = 1, fill = NA)\n  ) +\n  scale_fill_discrete(name = \"Fertilizer Level<br>\n                              <span style = 'font-size:8pt;'>\n                              (kg N ha<sup>-1</sup> y<sup>-1</sup>)\n                              </span>\") +\n  guides(\n    fill = guide_legend(override.aes = list(shape = 21, size = 5))\n  )  \n\nnmds.plot\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-22-1.pdf)\n:::\n:::\n\nWe can also add ellipses to the plot indicate confidence intervals  if you're interested in that:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Adding ellipses\"}\nnmds.plot +\n  stat_ellipse(aes(color = Fert_Level), size = 1, linetype = \"dashed\", show.legend = FALSE) \n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-24-1.pdf)\n:::\n:::\n\nAnd again with shading:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Adding shading\"}\nnmds.plot +\n  stat_ellipse(aes(color = Fert_Level), size = 1, linetype = \"dashed\", show.legend = FALSE) +\n    stat_ellipse(aes(fill = Fert_Level), size = 1, linetype = \"dashed\", show.legend = FALSE, geom = \"polygon\", alpha = 0.1) \n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-26-1.pdf)\n:::\n:::\n\n## Arrows!\n\nLet's calculate the loading factors of the individual amoas:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Calculating loadings\"}\ndune_dist <- vegdist(data.priming %>% select(starts_with('amoA')))\n\namoa_anosim <- anosim(dune_dist, data.priming$fert_level)\n\nmds.spp.fit <- envfit(mds.priming, data.priming.reduced %>% select(contains(\"amoa\")), permutations = 999)\n\nspp.scrs <- as.data.frame(scores(mds.spp.fit, display = \"vectors\")) \nspp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) \nspp.scrs <- cbind(spp.scrs, pval = mds.spp.fit$vectors$pvals)\n\nspp.scores <- as.data.frame(scores(mds.spp.fit, display = \"vectors\")) %>% \n  mutate(Species = rownames(.),\n         pval = mds.spp.fit$vectors$pvals)\n```\n:::\n\nThis is enough to plot arrows on the NMDS. \nWe'll show the loadings of some amoAs of interest that we identified in a previous analysis.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Plotting arrows\"}\nspecial <- c(\"amoA.012\", \"amoA.031\", \"amoA.035\", \"amoA.042\", \"amoA.045\", \"amoA.070\")\n\nspecial_arrows <- spp.scores %>% \n  rownames_to_column() %>% \n  filter(rowname %in% special) %>% \n  mutate(x = -0.25 * NMDS1,\n         y = -0.25 * NMDS2,\n         assay = str_sub(rowname, -2),\n         assay = paste0(\"amoA_AOB_p\", assay)\n         )\n\nnmds.plot +\n    geom_segment(data = special_arrows,\n               aes(x = 0, xend = -0.3 * NMDS1,\n                   y = 0, yend = -0.3 * NMDS2),\n               size = 0.66,\n               arrow = arrow(length = unit(0.25, \"cm\")),\n                             color = \"grey10\", lwd = 0.3,\n               inherit.aes = FALSE) +\n  ggrepel::geom_text_repel(\n    data = special_arrows,\n    aes(x * 1, y * 1, label = assay),\n    fontface = \"bold\",\n    size = 4,\n    inherit.aes = FALSE,\n    force = 1,\n    nudge_x = -0.001\n  ) +\n  annotate(\n    \"text\",\n    label = paste0(\"ANOSIM R = \", round(amoa_anosim$statistic, 2),\n                   \"\\np < 0.001\"),\n    x = 0.4,\n    y = 0.25,\n    size = 5,\n    fontface = 2\n  ) +\n  stat_ellipse(aes(color = Fert_Level), size = 1, linetype = \"dashed\", show.legend = FALSE)\n```\n\n::: {.cell-output-stderr}\n```\nWarning: Duplicated aesthetics after name standardisation: size\n```\n:::\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-30-1.pdf)\n:::\n:::\n\n\n## Statistics\n\n### Which factors have an impact on overall community composition?\n\n::: {.cell}\n\n```{.r .cell-code}\nX <- data.priming.reduced %>% \n  select(-c(contains(\"amoa\")))\nY <- data.priming.reduced %>% \n  select(c(contains(\"amoa\")))\n\nadonis(Y ~ X$fert_level + X$addition + X$crop + X$timepoint) \n```\n\n::: {.cell-output-stdout}\n```\n\nCall:\nadonis(formula = Y ~ X$fert_level + X$addition + X$crop + X$timepoint) \n\nPermutation: free\nNumber of permutations: 999\n\nTerms added sequentially (first to last)\n\n             Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    \nX$fert_level  1    1.4426 1.44255  56.092 0.37093  0.001 ***\nX$addition    2    0.0327 0.01633   0.635 0.00840  0.697    \nX$crop        1    0.0882 0.08823   3.431 0.02269  0.024 *  \nX$timepoint   1    0.0367 0.03671   1.427 0.00944  0.197    \nResiduals    89    2.2889 0.02572         0.58855           \nTotal        94    3.8890                 1.00000           \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\nThis tells us that fertilization level is very significant and explains ~37% of the variation\nin our samples. Crop is also a significant factor on community composition, though it only explains\n2.3% of the variation.\n\n### How do the treatment factors affect the \"abundance\" of genes on an individual level?\n\nAll the code below does is perform an ANOVA of the gene's abundance against all the terms\nand all of their interactions.\n\n::: {.cell}\n\n```{.r .cell-code}\nformulae <- lapply(colnames(data.priming.reduced %>% select(starts_with(\"amoA\"))), function(x) as.formula(paste0(x, \" ~ fert_level * crop * timepoint * addition\")))\n\nres <- lapply(formulae, function(x) broom::tidy(aov(x, data = data.priming.reduced)))\nnames(res) <- format(formulae)\nnames(res) <- str_sub(names(res), end = 8)\n\nanova_results <- lapply(seq_along(res), function(i) res[[i]] %>% mutate(gene = names(res)[[i]])) %>% \n  bind_rows() %>% \n  filter(term != \"Residuals\") %>% \n  mutate(sig = case_when(\n    p.value < 0.05 & p.value > 0.01 ~ \"*\",\n    p.value < 0.01 & p.value > 0.001 ~ \"**\",\n    p.value < 0.001 ~ \"***\",\n    TRUE ~ \"NS\"\n  ))\n```\n:::\n\nVisualization:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"ANOVA visualization\"}\nanova_results %>% \n  mutate(gene = str_sub(gene, -3)) %>% \n  ggplot(aes(gene, term, fill = sig)) + \n  geom_tile(color = \"black\") + \n  coord_equal() + \n  labs(y = \"\",\n       x = \"amoA\",\n       title = \"Summary of ANOVA results\",\n       fill = \"Significance \") + \n  theme(\n    plot.title = element_text(hjust = 0.5),\n    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)\n  ) + \n  scale_fill_viridis_d(option = \"magma\", direction = -1)\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-36-1.pdf)\n:::\n:::\n\nOverall, we see that, again, fertilization level has a significant impact on abundance levels of the individual genes, and it's not even really that close.\nThere are other factors that might be worth investigating on a gene-by-gene basis, too, but that's for later.\n\n## Biodiversity\n\nLet's start by visualizing the presence/absence table:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Presence/absence plot\"}\namoA_presence_absence %>% \n  pivot_longer(cols = starts_with(\"amoA\"), names_to = \"amoA\", values_to = \"presence\") %>% \n  mutate(amoA = str_sub(amoA, -2),\n         amoA = paste0(\"amoA_AOB_p\", amoA),\n         presence = as.factor(presence)) %>% \n  left_join(metadata %>% rownames_to_column(var = \"sample_id\")) %>% \n  mutate(strip_label = paste0(fert_level, \" kg N ha<sup>-1</sup> y<sup>-1</sup>\")) %>% \n  ggplot(aes(sample_id, amoA, fill = presence)) + \n  geom_tile(color = \"black\") +\n  labs(\n    x = \"Sample name\",\n    y = \"Primer pair\",\n    fill = \"Species is:\",\n    title = \"\",\n    subtitle = \"\"\n  ) + \n  scale_fill_viridis_d(labels = c(\"Absent\", \"Present\"),\n                       begin = 0, end = 1,\n                       option = \"magma\") +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25),\n    axis.text.y = element_text(size = 7),\n    plot.title = element_text(hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5),\n    strip.text = element_markdown(size = 10, face = \"bold\"),\n    strip.background = element_rect(size = 1, color = \"blaCk\", fill = NA),\n    plot.margin = unit(c(0, 0.1, 0.1, 0.1), \"cm\")\n  ) + \n  scale_y_discrete(limits = rev) + \n  facet_grid(~ strip_label, scales = \"free\")\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-38-1.pdf)\n:::\n:::\n\n## Reading in the best BLAST hit info:\n\n::: {.cell}\n\n```{.r .cell-code}\namoA_organism_info <- readxl::read_xlsx(\"data/amoa_mfp_qpcr_org_accessions.xlsx\", sheet = 5) %>% \n  select(-c(contains(c(\"forward\", \"reverse\", \"notes\")))) \n```\n:::\n\nCounts of best BLAST hits:\n\n::: {.cell}\n\n```{.r .cell-code}\namoA_organism_info %>% \n  count(best_blast_hits, sort = TRUE) \n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 25 x 2\n   best_blast_hits                               n\n   <chr>                                     <int>\n 1 Nitrosolobus multiformis AmoA (amoA) gene    10\n 2 Nitrosospira sp. En13 AmoA                    9\n 3 Nitrosospira multiformis ATCC 25196           7\n 4 Nitrosospira sp. Wyke8 AmoA                   7\n 5 Nitrosospira lacus strain APG3                6\n 6 Nitrosospira sp. Np39-19                      6\n 7 Nitrosospira sp. Wyke2                        4\n 8 Nitrosospira sp. NpAV                         3\n 9 Nitrosomonas sp. JL21                         2\n10 Nitrosospira briensis                         2\n# ... with 15 more rows\n```\n:::\n:::\n\n\n## Creating a phyloseq object\n\n\n::: {.cell}\n\n```{.r .cell-code}\namoa_tax_table <- amoA_organism_info %>% \n  select(array_name, best_blast_hits) %>% \n  column_to_rownames(var = \"array_name\") %>% \n  tax_table()\n\nrownames(amoa_tax_table) <- amoA_organism_info$array_name\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nps <- phyloseq(\n  otu_table(amoA_presence_absence %>% column_to_rownames(var = \"sample_id\"), taxa_are_rows = FALSE),\n  sample_data(metadata),\n  amoa_tax_table\n)\n```\n:::\n\n## Richness analysis\n\nHow does observed richness and evenness change with treatment level? This is a modified diversity function\nthat does a bunch of nice stuff that `phyloseq::estimate_richness` doesn't do.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Estimate richness function\"}\nestimate_richness_mod <- function(physeq, split=TRUE, measures=NULL){\n  \n\n  if( !split ){\n    OTU <- taxa_sums(physeq)\t\t\n  } else if( split ){\n    OTU <- as(otu_table(physeq), \"matrix\")\n    if( taxa_are_rows(physeq) ){ OTU <- t(OTU) }\n  }\n  \n\n  renamevec = c(\"Observed\", \"Chao1\", \"ACE\", \"Shannon\", \"Pielou\", \"Simpson\", \"InvSimpson\", \"SimpsonE\", \"Fisher\")\n  names(renamevec) <- c(\"S.obs\", \"S.chao1\", \"S.ACE\", \"shannon\", \"pielou\", \"simpson\", \"invsimpson\", \"simpsone\", \"fisher\")\n\n  if( is.null(measures) ){\n    measures = as.character(renamevec)\n  }\n\n  if( any(measures %in% names(renamevec)) ){\n    measures[measures %in% names(renamevec)] <- renamevec[names(renamevec) %in% measures]\n  }\n  \n\n  if( !any(measures %in% renamevec) ){\n    stop(\"None of the `measures` you provided are supported. Try default `NULL` instead.\")\n  }\n  \n\n  outlist = vector(\"list\")\n\n  estimRmeas = c(\"Chao1\", \"Observed\", \"ACE\")\n  if( any(estimRmeas %in% measures) ){\n    outlist <- c(outlist, list(t(data.frame(estimateR(OTU)))))\n  }\n  if( \"Shannon\" %in% measures ){\n    outlist <- c(outlist, list(shannon = diversity(OTU, index=\"shannon\")))\n  }\n  if( \"Pielou\" %in% measures){\n    #print(\"Starting Pielou\")\n    outlist <- c(outlist, list(pielou = diversity(OTU, index = \"shannon\")/log(estimateR(OTU)[\"S.obs\",])))\n  }\n  if( \"Simpson\" %in% measures ){\n    outlist <- c(outlist, list(simpson = diversity(OTU, index=\"simpson\")))\n  }\n  if( \"InvSimpson\" %in% measures ){\n    outlist <- c(outlist, list(invsimpson = diversity(OTU, index=\"invsimpson\")))\n  }\n  if( \"SimpsonE\" %in% measures ){\n\n    outlist <- c(outlist, list(simpsone = diversity(OTU, index=\"invsimpson\")/estimateR(OTU)[\"S.obs\",]))\n  }\n  if( \"Fisher\" %in% measures ){\n    fisher = tryCatch(fisher.alpha(OTU, se=TRUE),\n                      warning=function(w){\n                        warning(\"phyloseq::estimate_richness: Warning in fisher.alpha(). See `?fisher.fit` or ?`fisher.alpha`. Treat fisher results with caution\")\n                        suppressWarnings(fisher.alpha(OTU, se=TRUE)[, c(\"alpha\", \"se\")])\n                      }\n    )\n    if(!is.null(dim(fisher))){\n      colnames(fisher)[1:2] <- c(\"Fisher\", \"se.fisher\")\n      outlist <- c(outlist, list(fisher))\n    } else {\n      outlist <- c(outlist, Fisher=list(fisher))\n    }\n  }\n  out = do.call(\"cbind\", outlist)\n\n  namechange = intersect(colnames(out), names(renamevec))\n  colnames(out)[colnames(out) %in% namechange] <- renamevec[namechange]\n\n  colkeep = sapply(paste0(\"(se\\\\.){0,}\", measures), grep, colnames(out), ignore.case=TRUE)\n  out = out[, sort(unique(unlist(colkeep))), drop=FALSE]\n\n  out <- as.data.frame(out)\n  return(out)\n}\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Calculate richnesses for sample groups\"}\nmetrics <- c(\"Observed\", \"Shannon\")\nrichness <- estimate_richness_mod(ps, measures = metrics) %>% \n  rownames_to_column(var = \"sample_id\") %>% \n  mutate(sample_id = str_sub(sample_id, start = 2)) \n\nrichness <- left_join(sample_data(ps) %>% data.frame() %>% rownames_to_column(var = \"sample_id\"), richness) %>% \n  pivot_longer(cols = Observed:Shannon, names_to = \"Metric\", values_to = \"Value\")\n```\n\n::: {.cell-output-stderr}\n```\nJoining, by = \"sample_id\"\n```\n:::\n:::\n\n## Statistical tests\n\n### Significance test of fertilization level on richness.\n\n::: {.cell}\n\n```{.r .cell-code}\n(sig_rich_fert <- kruskal.test(Value ~ fert_level, data = richness %>% filter(Metric == \"Observed\")))\n```\n\n::: {.cell-output-stdout}\n```\n\n\tKruskal-Wallis rank sum test\n\ndata:  Value by fert_level\nKruskal-Wallis chi-squared = 54.212, df = 1, p-value = 1.8e-13\n```\n:::\n:::\n\nThe `p-value < 0.001` gives us strong statistical evidence that richness is significantly different between \nfertilization treatment groups.\n\n\n### Significance test of fertilization level on richness\n\n::: {.cell}\n\n```{.r .cell-code}\n(sig_even_fert <- kruskal.test(Value ~ fert_level, data = richness %>% filter(Metric == \"Shannon\")))\n```\n\n::: {.cell-output-stdout}\n```\n\n\tKruskal-Wallis rank sum test\n\ndata:  Value by fert_level\nKruskal-Wallis chi-squared = 54.268, df = 1, p-value = 1.75e-13\n```\n:::\n:::\n\nThe `p-value < 0.001` gives us strong statistical evidence that Shannon diversity is significantly different between \nfertilization treatment groups.\n\n## Making nice plots for stat differences\n\nStandard deviations, mean\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Generate alpha diversity plots\"}\nsummaries <- richness %>% \n  group_by(Metric, fert_level) %>% \n  summarize(mean_val = mean(Value), \n            sd_val = sd(Value),\n            n = n(),\n            .groups = \"drop\") %>% \n  mutate(se = abs((sd_val / sqrt(n)) * qt(0.025, n - 1) )) %>% \n  mutate(ymax = mean_val + se, \n         ymin = mean_val - se) \n\nthis_annotation <- data.frame(\n  Metric = c(\"Observed\", \"Shannon\"),\n  lab = c(\"***\", \"***\"),\n  x = 1.5,\n  y = c(50 + 5 + 2, 4 + 0.5),\n  lineheights = c(50 + 5, 4 + 0.25)\n)\n\nsummaries %>%  \n  ggplot(aes(fert_level, mean_val, fill = fert_level)) + \n  geom_col(color = \"black\", size = 1) +\n  facet_wrap(~ Metric, scales = \"free_y\") + \n  theme(\n    legend.position = \"none\",\n    strip.background = element_blank(),\n    axis.title.y = element_blank(),\n    strip.placement = \"outside\",\n    plot.title = element_text(hjust = 0.5),\n    strip.text.y = element_text(face = \"bold\", size = 10),\n    strip.text = element_text(face = \"bold\", size = 10),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray90\", linetype = \"dashed\"),\n    axis.ticks = element_blank(),\n    panel.border = element_rect(color = \"black\", size = 1, fill = \"NA\")\n  ) +\n  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) + \n  geom_errorbar(aes(ymin = ymin, ymax = ymax, width = 0.5)) + \n  geom_text(\n    data = this_annotation,\n    aes(x = x, y = y, label = lab),\n    inherit.aes = FALSE,\n    size = 5\n    ) + \n  geom_segment(data = this_annotation,\n               aes(x = 1,\n                   xend = 2, \n                   y = lineheights,\n                   yend = lineheights),\n               inherit.aes = FALSE) + \n  labs(\n    x = \"Fertilization Level\\n(*** = p < 0.001 by Kruskal Wallis)\",\n    title = \"Alpha diversity metrics by fertilization level\"\n    \n  )\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-52-1.pdf)\n:::\n:::\n\n## Beta diversity\n\nWe'll start beta diversity analysis off by doing an ADONIS/PERMANOVA to determine if \ntreatment centroids/treatment variations are different between groups. \n\n::: {.cell}\n\n```{.r .cell-code}\ndis <- vegdist(otu_table(ps))\ngroups <- sample_data(ps)$fert_level\nmod <- betadisper(dis, groups)\nanova(mod)\n```\n\n::: {.cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: Distances\n          Df  Sum Sq Mean Sq F value    Pr(>F)    \nGroups     1 0.52595 0.52595  24.589 3.228e-06 ***\nResiduals 92 1.96781 0.02139                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\nSince `p <<<< 0.0001`, there is strong evidence that the overall community compositions\nare significantly different (treatment centroid, distance to centroid, community variation)\nbetween the two groups. W can visualize this with a 1 SD ellipse:\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(mod, ellipse = TRUE, hull = FALSE) \n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-56-1.pdf)\n:::\n:::\n\nWe see that there is clear separation between the two treatment centroids. Let's do some more analysis on the \ndistance-to-centroids that we're seeing:\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Distance-to-centroid plots\"}\nbetadistances <- data.frame(\n  time_frame = mod$group,\n  distance = mod$distances\n)\n\nbetadistances %>% \n  ggplot(aes(time_frame, distance)) + \n  geom_boxplot(size = 1, outlier.shape = NA) + \n  geom_jitter(aes(fill = time_frame), size = 5, shape = 21, width = 0.2) +\n  theme(\n    legend.position = \"none\",\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    plot.title = element_text(size = 17),\n    plot.subtitle = element_text(size = 9),\n    axis.ticks.length = unit(0.25, \"cm\"),\n    axis.ticks.x = element_blank(),\n    axis.text.x = element_text(face = \"bold\", angle = 0, size = 12),\n    panel.border = element_rect(color = \"black\", size = 1, fill = NA),\n    axis.title.x = element_blank(),\n    axis.title.y = element_text(size = 14, face = \"bold\"),\n    \n  ) + \n  labs(\n    color = \"\",\n    y = \"Distance to centroid\"\n  ) +\n  ggsignif::geom_signif(\n    map_signif_level = TRUE,\n    comparisons = list(c(\"0\", \"336\")),\n    test = \"t.test\",\n    step_increase = 0.1,\n    color = \"black\",\n    size = 1,\n    textsize = 5,\n    tip_length = 0\n  )\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-58-1.pdf)\n:::\n:::\n\n\nThe significance bar is coming from the PERMANOVA test we did above. We see that there is actually\nless beta diversity (as meaasured by distance-to-centroid) in the fertilized group than in the non-\nfertilized group. We'll see another visualization backing this up in the next section:\n\n## Composition\n\nLet's visualize the composition of the communities, separated by fertilization. We'll start with\nraw counts - how many times was that best BLAST hit seen in that sample?\n\n::: {.cell}\n\n```{.r .cell-code}\ncomp_barplot(ps, \"ta1\",\n             facet_by = \"fert_level\",\n             sample_order =  \"default\",\n             tax_transform_for_plot = \"identity\") +\n  coord_flip() + \n  labs(\n    title = \"Sample composition by fertilization level\",\n    subtitle = \"(raw counts)\"\n  ) + \n  theme(\n    axis.text.x = element_blank(),\n    axis.text.y = element_text(margin = margin(r = -7)),\n    plot.title = element_text(hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5, size = 10),\n    strip.text = element_text(size = 10, face = \"bold\")\n  ) +\n  guides(\n    fill = guide_legend(title = \"Best BLAST hit\", reverse = TRUE)\n  )\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-60-1.pdf)\n:::\n:::\n\nWe see that overall the fertilized group appears to have more richness in it.\n\nHow about sample composition? IE, relative abundances?\n\n::: {.cell}\n\n```{.r .cell-code}\ncomp_barplot(ps, \"ta1\",\n             facet_by = \"fert_level\",\n             sample_order =  \"default\") +\n  coord_flip() + \n  labs(\n    title = \"Sample composition by fertilization level\",\n    subtitle = \"(relative abundance)\"\n  ) + \n  theme(\n    axis.text.x = element_blank(),\n    axis.text.y = element_text(margin = margin(r = -7)),\n    plot.title = element_text(hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5, size = 10),\n    strip.text = element_text(size = 10, face = \"bold\")\n  ) +\n  guides(\n    fill = guide_legend(title = \"Best BLAST hit\", reverse = TRUE)\n  )\n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-62-1.pdf)\n:::\n:::\n\nTwo big things pop out:\n\n* Species distribution is more even in the fertilized group. This makes sense given previous results\nshowing that Shannon entropy is higher and beta diversity is lower in the fertilized group. You can also \nsee that the communities just look more like each other in the fertilized group, which manifests in shorter\ndistance-to-centroids/lower community variation.\n* There's more green in the fertilized group, suggesting that Nitrosolobus multiformus and Nitrosospira sp. En13 abundances are significantly affected by fertilization addition.\n\n## Statistics on a best BLAST hit level\n\nThe next chunk is just doing some data transformation stuff to count the number of times\neach organism was seen in each sample in preparation for the statistical analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\npa_count <- ps %>% \n  otu_table() %>%\n  data.frame %>%\n  rownames_to_column(var = \"sample_id\") %>% \n  pivot_longer(starts_with(\"amoA\")) \n\n\norg_table <- tax_table(ps) %>% \n  data.frame %>% \n  rownames_to_column(var = \"name\") %>% \n  rename(bbh = ta1) %>% \n  mutate(cleaned_names = janitor::make_clean_names(bbh))\n\nbbh_sample_counts <- left_join(pa_count, org_table, by = \"name\") %>%\n  group_by(sample_id, bbh) %>% \n  summarize(value = sum(value)) %>% \n  pivot_wider(names_from = \"bbh\", values_from = value)\n\nbbh_level_counts <- left_join(bbh_sample_counts,\n          sample_data(ps) %>% \n            data.frame %>% \n            rownames_to_column(var = 'sample_id') %>% \n            right_join(bbh_sample_counts)\n) %>% \n  ungroup()\n```\n:::\n\nHere, we're preparing formulas to feed to a `lapply` function to perform a Kruskal-Wallis test on \nall of the organisms.\n\n::: {.cell}\n\n```{.r .cell-code}\nformulae <- lapply(colnames(bbh_sample_counts %>% select(-sample_id) %>% janitor::clean_names()) , function(x) as.formula(paste0(x, \" ~ fert_level * crop * timepoint * addition\")))\n\nformulae[[1]] <- NULL\n\nres <- lapply(formulae, function(x) broom::tidy(aov(x, data = bbh_level_counts %>% janitor::clean_names())))\nnames(res) <- format(formulae)\nnames(res) <- lapply(names(res), function(x) str_split(x, \"~\")[[1]][1]) %>% unlist()\n\nanova_results.counts <- lapply(seq_along(res), function(i) res[[i]] %>% mutate(gene = names(res)[[i]])) %>% \n  bind_rows() %>% \n  filter(term != \"Residuals\") %>% \n  mutate(gene = str_trim(gene))\n```\n:::\n\nVisualizing the results again:\n\n::: {.cell}\n\n```{.r .cell-code}\nanova_results.counts %>%\n  left_join(org_table, by = c(\"gene\" =\"cleaned_names\")) %>%\n  mutate(sig = case_when(\n    p.value < 0.05 & p.value > 0.01 ~ \"*\",\n    p.value < 0.01 & p.value > 0.001 ~ \"**\",\n    p.value < 0.001 ~ \"***\",\n    TRUE ~ \"NS\"\n  )) %>% \n  ggplot(aes(term, bbh, fill = sig)) + \n  geom_tile(color = \"black\") + \n  labs(y = \"\",\n       x = \"\",\n       title = \"Summary of ANOVA results\",\n       fill = \"Significance \") + \n  theme(\n    plot.title = element_text(hjust = 0.5),\n    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),\n    axis.text.y = element_text()\n  ) + \n  scale_fill_viridis_d(option = \"magma\", direction = -1) + \n  scale_y_discrete(limits = rev) +\n  coord_equal() \n```\n\n::: {.cell-output-display}\n![](four_files/figure-pdf/unnamed-chunk-68-1.pdf)\n:::\n:::\n\nWe see the same pattern at the organism level as when we did this at the gene level:\nfertilization level is by far the most significant factor affecting Presence/Absence of \norganisms.",
    "supporting": [
      "four_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": [],
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}